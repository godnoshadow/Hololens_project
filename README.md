## Hololens_project

### 研究思路

不同于以往的VR头戴设备依靠外置电脑的计算能力，混合现实设备Hololens作为微软第一款运行Windows10的全息计算设备，需要合理分配它的运算效能。实际上，三维虚拟场景中包含模型面的数量，码流，渲染，Shader，场景动画，视频，图片等，每一项都特别消耗效能，因此，在开发过程中，要把控视觉，内容，互动与效能之间的取舍。

在准备好开发所需要的环境后，下一步就是按照开发流程进行应用程序的开发。使用Unity游戏引擎进行开发HoloLens全息技术应用，具体步骤为：在Unity中导入用soliworks构建好的三维模型设备，结合Hololens的空间锚点和空间映射等特性设计虚拟设备管理维护系统，集成模型的拆解和维修功能，模型的移动和选择功能，辅助视频指导功能，辅助设备管理手册功能，基于手势识别与手势操作的人机交互系统，二维码的框架的设计与开发，然后使用Unity构建Universal Windows Platform的项目，接着在Visual Studio中开启这个工程项目，编译成功后部署到HoloLens设备或HoloLens模拟器上测试运行。

![img](file:///C:/Users/ZIYO/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg)

### 开发环境

开发引擎Unity，是一个全面专业的3D应用/游戏开发引擎，最大的特色是采用了“基于组件”的设计方式，软件架构有别于传统的面向对象开发。

基于组件的基本思路是：使用GameObject作为基础的框架，但GameObject并不具备任何实际功能，所有功能全部由组件（派生于MonoBehaviour的各种类）来实现，并能够任意附着到GameObject上，通过代码或编辑器操作均可。这样，GameObject就成为一系列组件的集合，能够完成各种复杂的功能。组件内部提供一系列预先定制的流程和接口，开发者可以在其中各个环节中添加各种逻辑，当组件附着到GameObject之后，会由GameObject统一调度这些流程和接口。

GameObject并不能独立存在，必须通过将其放入场景中，GameObject才拥有生命活动周期，换句话说，GameObject是依赖于场景而存在的。事实上，GameObject在创建时就会被Unity自动放入当前激活的场景之中。不过，Unity提供一种预设体的机制，允许开发者将一个编辑好的GameObject存储保存下来，之后可以用拖拽的方式放入任何场景，使得GameObject成为可复用的预设元件。

![img](file:///C:/Users/ZIYO/AppData/Local/Temp/msohtmlclip1/01/clip_image004.jpg)

### 可视化设备管理系统的开发与设计

通过打造可视化的设备管理系统混合现实产品平台。能够进行有效提升对自动化设备的管理工作效率以及提升人处理复杂信息的效率。相同设备管理场景能够将双方串联，消除了距离造成的沟通不畅，保证设备相关信息传递无损，而在终端用户的展示上，三维虚拟模型与混合现实空间的无缝融合，模拟出的环境也能极大还原设计方案所表达的效果，进而增强用户体验。本文从设备模型导入、人机交互设计、二维码框架设计三个方面缩短了设备管理时间并减少沟通成本。

基于混合现实平台的研发不同于过去基于屏幕的研发，信息的载体、基础的沉淀、设计的思维，以及方法方式都面临从0到1的过程。总体来说基于混合现实平台的开发是一个将信息在现实空间中展示的过程。需要思考信息在空间中的交互、布局方式、呈现方式；以及思考现实空间中信息与人以及事物的基本关系。本文基于混合现实技术的设备管理系统的开发可视化框架图如图所示：

![img](file:///C:/Users/ZIYO/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg)


#### 1. 三维模型的导入

模型搭建是系统开发的必要环节，是组成数据库的重要内容，也是实现虚拟拆装的基石，混合现实技术呈现的效果更加逼真、三维模型更加精确，同时支持与不同使用场景进行叠加。HoloLens可以显示的数据的物理特性，结合可交互式三维场景透视和叠加功能，可以提供比增强现实AR和虚拟现实VR更强的表现能力。

1.1 画面帧速的调整

此外，如果是低于30FPS渲染时，操作者就会看到两副一模一样的画面，并且两副画面之间有着16.6ms的延迟，降低画面清晰度，引发画面抖动等问题，严重影响到操作者的视觉感受，甚至会无法正常操作系统，要使画面具备平滑的流畅度，帧速（FPS）应尽量维持在60FPS左右。以60FPS渲染时，能够最大程度上减少操作者看到的画面和渲染后的画面之间的时差。由此，需要努力去优化程序和控制帧速，充分优化HoloLens的每一分性能，在流畅的帧速和绚丽的画面之间取得平衡。

1.2 三维模型的导入

具体的三维模型导入过程为，先把Soliworks的模型导入到Deep Exploration，并通过程序减少它的模型面数，转为fbs格式后导入Unity，再编写脚本控制它们的动作，为模型创建材质，调整模型的位置和尺寸，最后部署到Hololens时，还得调整好它的帧速。其中，有以下几点是需要注意的，在模型的使用与编写脚本中，为了能够随时创建出对象，首先需要对对象进行预设，还要注意物理材质的创建，物理材质是用于设定摩擦系数和弹性系数等与物体运动相关的参数。如图所示，需对模型的参数进行设置。通过1:1的三维视觉建模，三维声场建模，使用HoloLens进行沉浸式全息呈现，逼真还原生产设备的展示和操作，带来物理真实的操作感和空间感。

![img](file:///C:/Users/ZIYO/AppData/Local/Temp/msohtmlclip1/01/clip_image004.jpg)


1.3 模型面数的优化

操作者体验很大程度上会受到虚拟世界中全息物体的真实感的影响，影响真实感的原因很多，环境灯光布置、模型的面数、使用的材质等等都会影响真实感。其中，模型的面数可能是最直接的影响因素，面数越多，虚拟模型也就显得越发的真实。

在使用HoloLens观看这些高面数模型时，模型面数过多往往会占用太多效能，由于像HoloLens这样的移动设备的处理能力有限，甚至会导致设备完全停止运行，因此需要适当优化模型的面数来使模型的真实性不受影响。这样才不会使HoloLens的内存和GPU由于模型太复杂而过度消耗，影响人机交互的实时性和系统运行的稳定性与持续性。本文以虚拟可视化立体车库，机械手，无人机为例，以更好地测试与检验所开发的基于混合现实的设备管理系统。3D设备模型如图所示：

![img](file:///C:/Users/ZIYO/AppData/Local/Temp/msohtmlclip1/01/clip_image006.gif)


#### 2. 人机交互的设计

2.1 人机交互的光标设计

本系统采用射线碰撞检测的方式实现虚拟模型的选取，射线碰撞原理如图所示。系统通过HoloLens向用户眼睛凝视方向发射一条射线与虚拟三维模型零部件之间进行碰撞检测。射线与泵的某个虚拟部件交点为P。射线与前后剪切面相交于P1（X1，Y1，Z1）和P2（X2，Y2，Z2）点，通过P1点与P2点的坐标及连线可确定P点的信息。凝视是一种自然的交互方式，更符合人类的习惯，可用于选择操作全息对象。通过UnityEngine.Camera.main.transform. forward和UnityEngine.Camera.main.transform.position用Physics.RayCast发出射线后可以得到RaycastHit数据，该数据包含了碰撞点的3D位置参数和碰撞对象。

![img](file:///C:/Users/ZIYO/AppData/Local/Temp/msohtmlclip1/01/clip_image008.gif)

手势交互的定位机制是凝视，凝视与虚拟光标的结合，才能为接下来的手势交互提供基础，首先点击“Create Empty”创建一个空游戏对象，将其命名为Cursor，为Cursor对象添加核心脚本组件GazeManager.cs，接着添加为其设计好交互图案的Cursor，凝视光标如图所示，可实现当凝视在全息对象时，其表明出现一个青色光圈，表示操作者当前凝视该对象，当射线离开该全息模型后，Cursor就不会显示，以此来区分是否凝视全息对象。

![img](file:///C:/Users/ZIYO/AppData/Local/Temp/msohtmlclip1/01/clip_image010.jpg)

2.2 人机交互的手势设计

交互手势的实现是本系统另一大亮点，选中目标后可以通过交互手势进行移动和旋转，以便更好地了解机械设备的运行状态。本系统主要采用动态手势检测，将手放置于用户眼前120°×120°的视角里，通过采集人体手部骨骼节点的深度图，得出骨架节点的运动轨迹作为主要的手势识别特征；通过对比骨架节点的起点、终点和移动距离，然后处理计算分类，最终得出手势识别结果。两个重要手势分别为：（1）Manipulation手势：保持点击手势，在3D世界中绝对运动；（2）Airtap手势：主要是执行点击与确认命令。

其手势的开发流程如下：在“Scripts”文件夹中，创建一个名为GazeGestureManager的脚本。将GazeGestureManager脚本拖到层次结构中的三维虚拟模型对象上。在Visual Studio中编写GazeGestureManager脚本，根据Hololens头显位置和凝视方向发射射线的全息框检测手势，判断虚拟三维模型是否存在，存在则使用Airtap手势或者Manipulation手势，否则取消手势事件订阅。接着将应用程序导出，构建并部署到Hololens上，运行程序，执行手势，可移动和旋转三维虚拟模型。手势识别代码如图所示：

![img](file:///C:/Users/ZIYO/AppData/Local/Temp/msohtmlclip1/01/clip_image012.jpg)

#### 3.  二维码框架的开发

二维码识别技术，是一种以二维码作为特征点识别，获得场景相关信息的一种新方法。二维码标记可以以图片的形式设计制作，可以粘贴在大型企业机械生产设备管理操作面板、设备检修点等，二维码中记录了应用场景特征码和空间环境分析数据模型。通过利用混合现实技术能够与现实世界交互的特性，为可视化的设备管理系统解决方案引入了基于二维码的扫描和识别技术。HoloLens混合现实技术原生就支持与现实世界的交互，通过HoloLens能够扫描并识别现实环境中的特征信息，识别粘贴在自动化设备表面上的二维码，HoloLens能够从内部数据网络中搜索并获取相应的模型和数据，生成与该二维码对应的系统和实时全息影像，并且它们将呈现在对应的场景或指定位置上。

其开发流程如下：首先将ZXing库放在Plugins目录下，接着把qrcode.cs脚本挂到MainCamera上，创建一个canvas，创建RawImage和Text并拖拽到脚本上，其中Text是用于显示二维码内部信息的，RawImage是用于显示摄像头捕捉到的画面的。在Unity中打开Project Settings，在Publishing Settings中的Capabilities部分勾选WebCam能力，部署运行，Hololens就可以识别出二维码中的内容了。这种模式易于操作、价格低廉且易于部署，只要使用简单的二维码图片便可将现实世界与虚拟世界间连接起来。本项目设计的二维码框架如图所示：

![img](file:///C:/Users/ZIYO/AppData/Local/Temp/msohtmlclip1/01/clip_image014.jpg)

![img](file:///C:/Users/ZIYO/AppData/Local/Temp/msohtmlclip1/01/clip_image016.jpg)

#### 4.  信息用户界面的设计

4.1 混合现实界面的视觉效果

基于二维屏幕的UI界面基本上会通过视觉效果，如排列、大小、对比度等和动态效果上的隐喻帮助操作者理解不同界面或窗口所在的空间位置。在三维视觉空间内，混合现实场景又可以引入Z轴的纵深属性，所有可交互的对象都可以存在于一个三维视觉空间中的任意不同位置。三维空间中密集的UI界面搭配科技感十足的视觉呈现效果，虽然很炫，然而，在现实的三维空间中，复杂的UI界面对操作者快速获取有效的信息极为不利。考虑到应用技术性能的均衡发展需要、硬件设施设备FOV的局限性，不考虑将繁琐的界面设计元素一次性展示出来，由此本系统采用简洁的三维界面设计，固定大小，可翻页设计，实现操作的便捷性。

4.2 混合现实界面的三个位面

在沉浸式数字虚拟场景中，充分利用立体式分离的交互空间会有更好的显示效果，并且交互界面的设计可以有更大的想象空间。信息分布在真实空间中时，也就具备了区别物体信息与虚拟信息的基本位置特性，对于操作者而言，信息在混合现实空间中的位置可以分为信息相对定位于物和相对定位与人两种情况。

具体来说，可以把相对定位与人的位面称为追随环绕位面，信息的位面是跟随人的位面的变化而改变的，假设人和信息的距离是固定不变的，那么这一位面的信息就是以人为圆心的一个球形空间。然后把相对定位与物的位面称为相对模型位面，把这一层的信息认为是和现实信息融为一体的。

在实际的开发过程中，开发者还需要将一些特定的信息固定呈现在操作者面前，比如某一个关键数据，这些信息就像被固定在人的眼前那样，可以把这一层称为视觉常驻位面。这样就形成了完整的信息交互的三个位面。

4.3 混合现实界面的设计

通过数据驱动操作人员的效率，而这些信息如果一直呈现在操作人员的眼前会遮住操作者的视线，最终选择将三维空间数据界面放在操作人员只要抬头30度就可以观看的位置，无论操作人员如何移动，只要一抬头就可以看见，这个三维空间数据界面的位置和操作人员一直保持固定的距离，但会跟随着人的运动而移动，这一层正是追随环绕位面的应用。此外，将操控台界面放在相对模型位面，实现操作台与虚拟三维模型一直保持固定的距离，可以更方便快捷的对设备进行管理，操控台界面的设计如图所示，采用操控台界面，与数字仿真系统融合，营造真实的环境感和操作感。

![img](file:///C:/Users/ZIYO/AppData/Local/Temp/msohtmlclip1/01/clip_image018.jpg)

本系统将控制板，场景提示面板保持在视觉常驻位面，视觉常驻是比较常见的一种全息模型的行为，可以保证全息物体始终停留在视野范围内，同时使得全息内容跟随操作者平滑地运动，以及实现全息物体跟随操作者视角而转动，使得其信息内容始终朝向操作者。并且随着操作者距离的远近，其自身的尺寸也随之伸缩，从而使其在操作者视野中展现效果始终保持一致。

### 本可视化设备管理系统的应用

1. 高效可靠的MR巡检体验
   让巡检人员佩戴HoloLens，通过物联网设备上传关键数据信息，在后台做好数据分析，让运维巡检人员通过混合现实影像，可方便快捷地查看设备，并且能够方便的查看任意一台设备的详细的历史数据，状态分析等数据。实际操作如图所示：
   ![img](file:///C:/Users/ZIYO/AppData/Local/Temp/msohtmlclip1/01/clip_image022.jpg)

2. 基于MR的运维培训
   由于设备管理系统太过庞大，基础设备种类繁多，操作流程复杂，操作维护人员通常要进行岗前培训以及实操导师指导培训。在运维行业整体人员流动率高达25-30％的状况下，培训周期将造成人力补给压力倍增。
   该设备管理系统可提供全方位运维培训服务，除了可以呈现专业操作的SOP教程，同时可以利用混合现实技术，操作人员可以进行实时的运维步骤辅导，像强电设备，柴油发电机组等高危且复杂的设备，可提供全方位的操作方法指导。使用基于混合现实技术的可视化系统来运维培训后，可以让学习曲线下降，岗前培训周期可以缩短很多天，为混合现实设备操作维护提供指导，可以释放培训指导人员的人力资源，解决行业运维岗位紧缺问题。

3. 绿色节能，推动可持续化发展目标
   整个解决方案中采用的HoloLens设备管理方案，不受现场地域的局限，可随时随地展示设备管理维护流程，在有限的空间环境展示更多丰富的内容，演示完成后关闭系统即可，提高了工作效率，且绿色环保；相较于传统物理沙盘，全息解决方案可按照用户需求随时调整更新内容，提升了一个系统的使用率，帮助企业节省展厅维护成本，大量制作成本以及参观拜访带来的停工成本。

4. 减少安全风险，提升客户体验，提高生产效率
   现场参观机械设备生产间通常会带来一些潜在的安全风险，随着可视化的设备管理系统方案的出现，可以让工作研究人员不必再担心参观客户的人身安全，同时接待的访客数量也增加了，提升企业的开发效率同时，节省了客户的时间，保证了企业正常的生产系统安全。在核心数据及流程隐私保密的同时，也最大限度地保护了企业利益。
   对于机械设备生产车间这样的特殊生产工作环境，出于安全问题考虑，有些生产线每次访问都需要暂停作业，导致企业发展几乎每次都要为此承受更多的生产延误所造成的损失。可视化的设备管理系统解决方案的出现，有助于减少企业走访给生产线带来的中断，并在实际生产工作中最大限度地利用人力和物力资源。

[![Watch the video](https://imgtu.com/i/gvSUPK)](https://youtu.be/JNc0BoFEDOI)